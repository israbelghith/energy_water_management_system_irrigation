<div class="debit-container">
  <h2>Gestion des DÃ©bits MesurÃ©s</h2>

  <div class="alert alert-error" *ngIf="error">
    {{ error }}
  </div>

  <!-- Actions Bar -->
  <div class="actions-bar">
    <div class="left-actions">
      <button class="btn btn-primary" (click)="openCreateForm()">
        â• Ajouter une Mesure
      </button>

      <div class="filter-group">
        <select [(ngModel)]="selectedPompeId" (change)="filterByPompe()" class="select-filter">
          <option [value]="null">Toutes les pompes</option>
          <option *ngFor="let pompe of pompes" [value]="pompe.id">
            {{ pompe.reference }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <div class="loading" *ngIf="loading && !showForm">
    Chargement...
  </div>

  <!-- Form Modal -->
  <div class="modal" *ngIf="showForm">
    <div class="modal-content">
      <h3>Ajouter une Mesure de DÃ©bit</h3>
      <form (ngSubmit)="saveDebit()">
        <div class="form-group">
          <label for="pompeId">Pompe:</label>
          <select
            id="pompeId"
            [(ngModel)]="debitForm.pompeId"
            name="pompeId"
            required
          >
            <option *ngFor="let pompe of pompes" [value]="pompe.id">
              {{ pompe.reference }} ({{ pompe.statut }})
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="debit">DÃ©bit:</label>
          <input
            type="number"
            id="debit"
            [(ngModel)]="debitForm.debit"
            name="debit"
            required
            min="0"
            step="0.01"
          >
        </div>

        <div class="form-group">
          <label for="unite">UnitÃ©:</label>
          <select
            id="unite"
            [(ngModel)]="debitForm.unite"
            name="unite"
            required
          >
            <option value="mÂ³/h">mÂ³/h</option>
            <option value="L/s">L/s</option>
            <option value="L/min">L/min</option>
          </select>
        </div>

        <div class="form-group">
          <label for="dateMesure">Date de Mesure:</label>
          <input
            type="datetime-local"
            id="dateMesure"
            [(ngModel)]="debitForm.dateMesure"
            name="dateMesure"
            required
          >
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="loading">
            {{ loading ? 'Enregistrement...' : 'Enregistrer' }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="closeForm()">
            Annuler
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Debits Table -->
  <div class="table-container" *ngIf="!loading || showForm">
    <table class="data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Pompe</th>
          <th>Statut Pompe</th>
          <th>DÃ©bit</th>
          <th>UnitÃ©</th>
          <th>Date de Mesure</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let debit of debits">
          <td>{{ debit.id }}</td>
          <td>{{ getPompeName(debit.pompeId) }}</td>
          <td>
            <span class="status-badge" [ngClass]="'status-' + getPompeStatus(debit.pompeId).toLowerCase()">
              {{ getPompeStatus(debit.pompeId) }}
            </span>
          </td>
          <td>{{ debit.debit | number:'1.2-2' }}</td>
          <td>{{ debit.unite }}</td>
          <td>{{ debit.dateMesure | date:'dd/MM/yyyy HH:mm' }}</td>
          <td class="action-cell">
            <button
              class="btn btn-xs btn-success"
              (click)="verifierDisponibiliteElectrique(debit.pompeId)"
              [disabled]="checkingEnergy"
              title="VÃ©rifier disponibilitÃ© Ã©lectrique">
              âš¡ VÃ©rifier Ã‰nergie
            </button>
            <button
              class="btn btn-xs btn-info"
              (click)="getDebitMoyen(debit.pompeId)"
              title="Calculer dÃ©bit moyen">
              ğŸ“Š DÃ©bit Moyen
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="no-data" *ngIf="!loading && debits.length === 0 && !showForm">
    Aucune mesure de dÃ©bit enregistrÃ©e. Cliquez sur "Ajouter une Mesure" pour commencer.
  </div>

  <!-- Info Box -->
  <div class="info-box" *ngIf="!loading && debits.length > 0">
    <h4>ğŸ’¡ Communication Synchrone</h4>
    <p>Utilisez le bouton "VÃ©rifier Ã‰nergie" pour interroger le microservice Ã‰nergie
       et vÃ©rifier la disponibilitÃ© Ã©lectrique avant le dÃ©marrage d'une pompe.</p>
  </div>
</div>
